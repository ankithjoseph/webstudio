# Webstudio Production Docker Compose
# Use this as a reference for Easypanel deployment
# Each service should be created separately in Easypanel

version: "3.8"

volumes:
  postgres_data:
  
networks:
  webstudio-network:
    driver: bridge

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: webstudio
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: webstudio
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - webstudio-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U webstudio"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # PostgREST API
  # ============================================
  postgrest:
    image: postgrest/postgrest:v12.2.0
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGRST_DB_URI: postgresql://webstudio:${POSTGRES_PASSWORD:-changeme}@postgres:5432/webstudio
      PGRST_DB_SCHEMAS: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_DB_MAX_ROWS: 1000
    networks:
      - webstudio-network
    ports:
      - "3001:3000"

  # ============================================
  # Webstudio Builder Application
  # ============================================
  builder:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      postgrest:
        condition: service_started
    environment:
      # Database
      DATABASE_URL: postgresql://webstudio:${POSTGRES_PASSWORD:-changeme}@postgres:5432/webstudio?pgbouncer=true
      DIRECT_URL: postgresql://webstudio:${POSTGRES_PASSWORD:-changeme}@postgres:5432/webstudio
      
      # PostgREST
      POSTGREST_URL: http://postgrest:3000
      POSTGREST_API_KEY: ${POSTGREST_API_KEY}
      
      # Authentication
      AUTH_SECRET: ${AUTH_SECRET}
      
      # OAuth (configure at least one)
      GH_CLIENT_ID: ${GH_CLIENT_ID:-}
      GH_CLIENT_SECRET: ${GH_CLIENT_SECRET:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      
      # Development login (set to true for testing without OAuth)
      DEV_LOGIN: ${DEV_LOGIN:-false}
      
      # Application
      DEPLOYMENT_ENVIRONMENT: production
      DEPLOYMENT_URL: ${DEPLOYMENT_URL:-http://localhost:3000}
      PORT: 3000
      
      # Features
      FEATURES: "*"
      USER_PLAN: pro
      
      # Asset Storage (S3-compatible, optional)
      S3_BUCKET: ${S3_BUCKET:-}
      S3_REGION: ${S3_REGION:-}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE:-10}
      MAX_ASSETS_PER_PROJECT: ${MAX_ASSETS_PER_PROJECT:-50}
    networks:
      - webstudio-network
    ports:
      - "3000:3000"
